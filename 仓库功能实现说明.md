# 仓库界面功能实现说明

## 新增功能概览

本次更新为卡牌仓库界面实现了两个主要功能：

### 1. 卡牌分解功能
对于仓库内数量为复数张（多张）的卡牌，玩家可以进行分解操作获取钻石。

#### 分解规则：
- **SSR级别卡牌**：分解获得 **100钻石/张**
- **SR级别卡牌**：分解获得 **50钻石/张**  
- **R级别卡牌**：分解获得 **20钻石/张**
- **N级别卡牌**：分解获得 **1钻石/张**

#### 分解限制：
- 只有拥有2张及以上的卡牌才能进行分解
- 每次分解至少保留1张卡牌
- 可以自由选择分解数量（在限制范围内）

#### 操作方式：
1. 在仓库界面，拥有多张的卡牌会显示"分解"按钮
2. 点击分解按钮打开分解对话框
3. 选择要分解的数量
4. 确认分解操作
5. 获得相应的钻石奖励

### 2. 多维度排序功能
支持按照不同维度对卡牌进行排序，提升用户体验。

#### 排序选项：
- **稀有度排序**：按照SSR > SR > R > N的顺序排列
- **等级排序**：按照卡牌等级从高到低排列
- **数量排序**：按照拥有数量从多到少排列
- **名称排序**：按照卡牌名称字母顺序排列

#### 排序特性：
- 相同主要排序条件时，会按照名称进行二级排序
- 排序结果会实时应用到当前的过滤结果上
- 排序选择会保持到页面刷新

## 技术实现详情

### 后端实现

#### 新增API接口
```
POST /api/user/cards/decompose
```

**请求参数：**
```json
{
  "cardId": "卡牌ID",
  "quantity": "分解数量"
}
```

**响应数据：**
```json
{
  "success": true,
  "message": "成功分解X张SSR卡牌，获得XXX钻石",
  "gemsGained": "获得的钻石数量",
  "newUserResources": {
    "gems": "更新后的钻石数量",
    "coins": "更新后的金币数量"
  }
}
```

#### 核心逻辑
1. **事务处理**：使用数据库事务确保分解操作的原子性
2. **数量验证**：严格验证用户拥有的卡牌数量和分解限制
3. **资源更新**：同时更新用户钻石和卡牌数量
4. **错误处理**：完善的错误处理和回滚机制

### 前端实现

#### 新增组件状态
```javascript
const [showDecomposeDialog, setShowDecomposeDialog] = useState(false);
const [decomposeQuantity, setDecomposeQuantity] = useState(1);
const [isDecomposing, setIsDecomposing] = useState(false);
const [sortBy, setSortBy] = useState('rarity');
```

#### 排序算法
实现了智能排序函数，支持多维度排序：
- 主排序条件：按选择的排序方式排序
- 次排序条件：按名称字母顺序排序
- 保证排序结果的稳定性和一致性

#### UI/UX改进
1. **分解按钮**：只在多张卡牌上显示，避免误操作
2. **分解对话框**：清晰展示分解信息和预期收益
3. **数量控制**：提供直观的数量选择器
4. **排序选择器**：与现有的稀有度过滤器并列显示
5. **实时反馈**：操作过程中的loading状态和成功提示

## 用户界面变化

### 卡牌列表界面
- 添加了排序选择下拉框
- 多张卡牌的卡片底部显示分解按钮
- 卡牌数量显示方式调整为"数量：X"

### 卡牌详情界面
- 多张卡牌的详情页面添加分解按钮
- 详细显示卡牌的所有属性信息

### 分解对话框
- 卡牌基本信息展示
- 数量选择器（+/-按钮和数字输入框）
- 实时计算分解收益预览
- 确认和取消操作按钮

## 数据库更新

### 修改的查询
```sql
-- 获取用户卡牌时保留原始稀有度信息
SELECT 
  MIN(uc.user_card_id) as user_card_id,
  uc.card_id,
  -- ... 其他字段
  c.rarity, -- 保留原始稀有度用于分解计算
  COUNT(*) as quantity
FROM user_cards uc
JOIN cards c ON uc.card_id = c.card_id
WHERE uc.user_id = ?
GROUP BY uc.card_id, ...
```

### 分解操作事务
```sql
-- 1. 验证用户卡牌数量
-- 2. 删除指定数量的卡牌
-- 3. 更新用户钻石数量
-- 4. 返回更新后的用户资源
```

## 错误处理

### 前端错误处理
- 网络请求失败的重试机制
- 用户友好的错误提示信息
- 操作按钮的禁用状态管理

### 后端错误处理
- 参数验证和边界检查
- 数据库操作的事务回滚
- 详细的错误日志记录

## 测试建议

### 功能测试
1. 测试分解功能的各种边界情况
2. 验证排序功能的正确性
3. 测试分解后的资源更新
4. 验证UI交互的流畅性

### 性能测试
1. 大量卡牌时的排序性能
2. 分解操作的响应时间
3. 数据库查询的优化效果

## 未来扩展

### 可能的功能扩展
1. 批量分解功能
2. 分解历史记录
3. 更多排序维度（获得时间、攻击力等）
4. 分解确认的二次确认机制
5. 分解动画效果

### 技术优化
1. 前端状态管理优化
2. 数据库查询性能优化
3. UI组件的复用性提升 